FROM centos:8

ARG VARNISH_VER
ARG VARNISH_URL

RUN dnf -y update && \
    dnf -y install epel-release dnf-plugin-config-manager && \
    dnf -y config-manager --set-enabled powertools && \
    dnf -y group install "Development Tools" && \
    dnf -y install unzip wget curl git

RUN dnf -y install python3-sphinx libedit-devel jemalloc-devel python3-docutils ncurses-devel pcre-devel pcre2-devel

RUN rm -rf /tmp/varnish && \
    mkdir /tmp/varnish && \
    cd /tmp/varnish && \
    mkdir src && \
    curl -sL ${VARNISH_URL} | tar zx -C src --strip-components 1 && \
    cd src && \
    ./autogen.sh && \
    ./configure --prefix=/usr && \
    make -sj32 && \
    make install

WORKDIR /tmp/varnish/
